<script>
  (function () {
    const listEl = document.getElementById("list");
    const formEl = document.getElementById("add-form");
    const nameInput = document.getElementById("name-input");
    const subtitleInput = document.getElementById("subtitle-input");
    const messageEl = document.getElementById("message");
    const flushIpsBtn = document.getElementById("flush-ips");
    const flushAllBtn = document.getElementById("flush-all");

    const ADMIN_TOKEN_KEY = "dotpoll-admin-token";

    function setMessage(text, kind) {
      messageEl.textContent = text || "";
      messageEl.classList.remove("error", "success");
      if (kind === "error") messageEl.classList.add("error");
      if (kind === "success") messageEl.classList.add("success");
    }

    function getAdminToken() {
      let token = localStorage.getItem(ADMIN_TOKEN_KEY);
      if (!token) {
        token = window.prompt("Enter admin token:");
        if (!token) {
          setMessage("Admin token is required to use this page.", "error");
          throw new Error("No admin token");
        }
        localStorage.setItem(ADMIN_TOKEN_KEY, token);
      }
      return token;
    }

    function clearAdminToken() {
      localStorage.removeItem(ADMIN_TOKEN_KEY);
    }

    async function fetchState() {
      const res = await fetch("/api/state", {
        headers: { "Cache-Control": "no-store" }
      });
      if (!res.ok) throw new Error("Failed to load state from server.");
      return res.json();
    }

    async function addContestant(name, subtitle) {
      const token = getAdminToken();
      const res = await fetch("/api/admin-contestants", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-admin-token": token,
        },
        body: JSON.stringify({ name, subtitle }),
      });

      if (res.status === 401) {
        clearAdminToken();
        throw new Error("Invalid admin token.");
      }

      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.ok) {
        throw new Error(data.error || "Failed to add contestant.");
      }
      return data;
    }

    async function removeContestant(id) {
      const token = getAdminToken();
      const res = await fetch("/api/admin-contestants", {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          "x-admin-token": token,
        },
        body: JSON.stringify({ id }),
      });

      if (res.status === 401) {
        clearAdminToken();
        throw new Error("Invalid admin token.");
      }

      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.ok) {
        throw new Error(data.error || "Failed to remove contestant.");
      }
      return data;
    }

    async function adminReset(action) {
      const token = getAdminToken();
      const res = await fetch("/api/admin-reset", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-admin-token": token,
        },
        body: JSON.stringify({ action }),
      });

      if (res.status === 401) {
        clearAdminToken();
        throw new Error("Invalid admin token.");
      }

      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.ok) {
        throw new Error(data.error || "Reset failed.");
      }
      return data;
    }

    function renderFromState(state) {
      const { contestants = [], totals = {} } = state || {};
      listEl.innerHTML = "";

      if (!contestants.length) {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="item-main">
            <div class="item-name">No contestants yet.</div>
            <div class="item-sub">Add some above and they will appear on the voting page.</div>
          </div>
        `;
        listEl.appendChild(div);
        return;
      }

      // sort by votes desc
      const sorted = [...contestants].sort(
        (a, b) => (totals[b.id] || 0) - (totals[a.id] || 0)
      );

      sorted.forEach((c) => {
        const div = document.createElement("div");
        div.className = "item";
        const total = totals[c.id] || 0;

        div.innerHTML = `
          <div class="item-main">
            <div class="item-name">${c.name}</div>
            <div class="item-sub">${c.subtitle || "&nbsp;"}</div>
          </div>
          <div class="item-meta">
            <span class="badge">Total votes: ${total}</span>
            <button class="danger-button" type="button">Remove</button>
          </div>
        `;

        const removeBtn = div.querySelector("button.danger-button");
        removeBtn.addEventListener("click", async () => {
          const confirmed = confirm(
            \`Remove "\${c.name}" and all of its votes?\`
          );
          if (!confirmed) return;

          try {
            setMessage("", null);
            await removeContestant(c.id);
            setMessage(\`Removed "\${c.name}".\`, "success");
            await render(); // reload from server
          } catch (err) {
            setMessage(err.message, "error");
          }
        });

        listEl.appendChild(div);
      });
    }

    async function render() {
      try {
        const state = await fetchState();
        renderFromState(state);
      } catch (err) {
        console.error(err);
        setMessage(err.message, "error");
      }
    }

    formEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = nameInput.value.trim();
      const subtitle = subtitleInput.value.trim();

      if (!name) {
        setMessage("Name is required.", "error");
        return;
      }

      try {
        setMessage("", null);
        await addContestant(name, subtitle);
        setMessage(\`Added "\${name}".\`, "success");
        nameInput.value = "";
        subtitleInput.value = "";
        await render();
      } catch (err) {
        setMessage(err.message, "error");
      }
    });

    flushIpsBtn.addEventListener("click", async () => {
      try {
        setMessage("", null);
        await adminReset("flushIps");
        setMessage("All voter IPs have been cleared. Old users can vote again.", "success");
      } catch (err) {
        setMessage(err.message, "error");
      }
    });

    flushAllBtn.addEventListener("click", async () => {
      if (!confirm("Flush ALL contestants and votes? This cannot be undone.")) return;
      try {
        setMessage("", null);
        await adminReset("flushAll");
        setMessage("All contestants & votes have been cleared.", "success");
        await render();
      } catch (err) {
        setMessage(err.message, "error");
      }
    });

    // initial render (public state)
    render();
  })();
</script>